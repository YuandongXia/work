name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      TOOLCHAIN_PATH: ${{ github.workspace }}/toolchain/csky-elfabiv2-tools/bin
      WM_TOOLS_PATH: ${{ github.workspace }}/tools/wm
      WM_IOT_SDK_PATH: ${{ github.workspace }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build ccache python3 python3-tk

    - name: Download and extract csky-elfabiv2-tools
      run: |
        curl -L https://occ-oss-prod.oss-cn-hangzhou.aliyuncs.com/resource//1695011075810/csky-elfabiv2-tools-x86_64-minilibc-20210423.tar.gz --output ${GITHUB_WORKSPACE}/toolchain.tar.gz
        mkdir toolchain
        tar -xzf ${{ github.workspace }}/toolchain.tar.gz -C toolchain
        ls -al
        ls -al ./toolchain/csky-elfabiv2-tools/bin

    - name: Check environment setup
      run: |
        echo "PATH=$TOOLCHAIN_PATH:$WM_TOOLS_PATH:$PATH" >> $GITHUB_ENV
        echo "Working directory: ${{ github.workspace }}"
        echo "Current PATH: $PATH" 
        echo "SDK path: $WM_IOT_SDK_PATH"
        python3 --version
        cmake --version
        csky-elfabiv2-gcc --version
